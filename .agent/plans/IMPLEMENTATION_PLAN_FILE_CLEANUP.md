# 📋 구현 계획서: 파일 관리 및 데이터 자동 파기 로직 최적화

## 🧠 분석
- **현 상태**: 
    - 임시 번역(로컬)은 스트리밍 방식으로 처리되어 서버에 저장되지 않음.
    - 비동기 번역(드라이브 등)은 Supabase `documents` 버킷에 저장됨.
    - 현재 `cleanup-old-files` 에지 함수가 존재하나, 주로 `original_file_path`만 타겟팅하고 있음.
- **결함(Gap)**: 번역된 결과 파일인 `translated_file_path`가 삭제 루프에 명시적으로 포함되어 있지 않아, 10일 후 원본만 지워지고 결과물은 스토리지에 남게 되는 '고립된 파일(Orphan Files)' 문제가 발생할 수 있음.
- **요구사항**: 보안 및 비용 효율성을 위해 10일의 보관 기간이 지나면 해당 작업과 관련된 모든 흔적(입력 및 출력 파일)을 완벽하게 파기해야 함.

## 🛠️ 수정 제안 사항

### 1. `supabase/functions/cleanup-old-files/index.ts` (업데이트)
- SQL 쿼리를 수정하여 `original_file_path`와 `translated_file_path`를 모두 선택하도록 변경.
- `storage.remove()` 호출 시 두 경로가 모두 존재하면 배열에 담아 한 번에 삭제하도록 로직 보강.
- 삭제 실패 시의 에러 로깅을 세분화하여 관리자 모니터링 강화.

### 2. `.agent/plans/` 관리 (표준화)
- 모든 계획서는 `.agent/plans/[날짜]_[제목].md` 형식을 유지하며 반드시 한국어로 작성함.

### 3. 문서 업데이트
- `DECISION_LOG.md`에 10일 완전 파기 프로토콜을 명시하여 시스템의 데이터 처리 정책을 기록함.

## ✅ 검증 계획
1. **드라이 런(Dry Run)**: 실제로 파일을 지우지 않고 삭제 대상 목록만 로그에 출력하여 정상 작동 확인.
2. **경로 무결성 검사**: `translated_file_path`가 DB에 정확히 기록되는지 재확인.
3. **최종 테스트**: 10일 전 데이터를 생성한 후 함수를 실행하여 Supabase 스토리지 버킷에서 두 파일이 모두 사라지는지 시각적으로 확인.

---
**상태**: [승인됨 - 구현 중]
